{% extends "base.html" %}

{% block title %}Metronome - OpenHands{% endblock %}

{% block extra_css %}
<style>
    .message-box {
        margin-top: 1rem;
        padding: 0.75rem;
        border-radius: 0.375rem;
        display: none;
    }

    .message-box.success {
        display: block;
        background-color: #dcfce7;
        color: #166534;
        border: 1px solid #86efac;
    }

    .message-box.error {
        display: block;
        background-color: #fee2e2;
        color: #991b1b;
        border: 1px solid #fecaca;
    }

    .form-input {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #e2e8f0;
        border-radius: 0.375rem;
        font-size: 1rem;
        margin-bottom: 1rem;
    }

    .metronome-container {
        text-align: center;
        padding: 2rem;
    }

    .tempo-display {
        font-size: 4rem;
        font-weight: 700;
        color: var(--primary-color);
        margin: 1rem 0;
    }

    .tempo-controls {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin: 1rem 0;
    }

    .tempo-slider {
        width: 300px;
        margin: 2rem 0;
    }

    .beat-indicator {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background-color: #e2e8f0;
        margin: 1rem auto;
        transition: background-color 0.1s ease;
    }

    .beat-indicator.active {
        background-color: var(--primary-color);
    }

    .time-signature {
        margin: 1rem 0;
    }

    .time-signature select {
        padding: 0.5rem;
        border-radius: 0.375rem;
        border: 1px solid #e2e8f0;
        margin: 0 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <h2>Create Customer</h2>
    <div class="form-group">
        <label for="customerName">Customer Name:</label>
        <input type="text" id="customerName" name="customerName" class="form-input">
    </div>
    <button onclick="createCustomer()">Create Customer</button>
    <div id="customerMessage" class="message-box"></div>
    
    <div class="customer-list">
        <h3>Existing Customers</h3>
        <ul id="customerList"></ul>
    </div>
</div>

<div class="card metronome-container">
    <h1>Metronome</h1>
    
    <div class="beat-indicator" id="beatIndicator"></div>
    
    <div class="tempo-display">
        <span id="tempoDisplay">120</span> BPM
    </div>
    
    <div class="tempo-controls">
        <button onclick="adjustTempo(-5)">-5</button>
        <button onclick="adjustTempo(-1)">-1</button>
        <button onclick="toggleMetronome()" id="toggleButton">Start</button>
        <button onclick="adjustTempo(1)">+1</button>
        <button onclick="adjustTempo(5)">+5</button>
    </div>
    
    <input type="range" min="40" max="208" value="120" class="tempo-slider" id="tempoSlider">
    
    <div class="time-signature">
        <label for="beatsPerMeasure">Time Signature:</label>
        <select id="beatsPerMeasure" onchange="updateTimeSignature()">
            <option value="2">2/4</option>
            <option value="3">3/4</option>
            <option value="4" selected>4/4</option>
            <option value="6">6/8</option>
        </select>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Metronome API integration
    const METRONOME_API_KEY = '9bfd0288727d109c3ae126775c38aca41e798147ee2033fd80c54fbd34d2ac44';
    
    async function createCustomer() {
        const customerName = document.getElementById('customerName').value.trim();
        
        if (!customerName) {
            showMessage('Please enter a customer name', 'error');
            return;
        }

        try {
            // First, create customer in Metronome API
            const metronomeResponse = await fetch('https://api.metronome.com/v1/customers', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${METRONOME_API_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: customerName
                })
            });

            const metronomeData = await metronomeResponse.json();

            if (!metronomeResponse.ok) {
                throw new Error(metronomeData.message || 'Failed to create customer in Metronome');
            }

            // Then, create customer in our database
            const localResponse = await fetch('/api/customers', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: customerName,
                    metronome_id: metronomeData.id
                })
            });

            const localData = await localResponse.json();

            if (!localResponse.ok) {
                throw new Error(localData.error || 'Failed to create customer in local database');
            }

            showMessage(`Customer "${customerName}" created successfully!`, 'success');
            document.getElementById('customerName').value = '';
            loadCustomers();
        } catch (error) {
            showMessage(`Error: ${error.message}`, 'error');
        }
    }

    async function loadCustomers() {
        try {
            const response = await fetch('/api/customers');
            const customers = await response.json();
            
            const customerList = document.getElementById('customerList');
            customerList.innerHTML = customers.map(customer => 
                `<li>${customer.name} (ID: ${customer.metronome_id})</li>`
            ).join('');
        } catch (error) {
            console.error('Error loading customers:', error);
        }
    }

    function showMessage(message, type) {
        const messageBox = document.getElementById('customerMessage');
        messageBox.textContent = message;
        messageBox.className = `message-box ${type}`;
        
        // Hide message after 5 seconds
        setTimeout(() => {
            messageBox.className = 'message-box';
        }, 5000);
    }
    let audioContext = null;
    let currentBeat = 0;
    let isPlaying = false;
    let tempo = 120;
    let intervalId = null;
    let nextNoteTime = 0;
    let beatsPerMeasure = 4;

    function createAudioContext() {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }

    function playClick() {
        const osc = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        osc.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        // Use different frequencies for strong and weak beats
        osc.frequency.value = currentBeat === 0 ? 1000 : 800;
        
        gainNode.gain.value = 0.5;
        osc.start(nextNoteTime);
        osc.stop(nextNoteTime + 0.1);
        
        // Visual feedback
        const indicator = document.getElementById('beatIndicator');
        indicator.classList.add('active');
        setTimeout(() => indicator.classList.remove('active'), 100);
    }

    function nextBeat() {
        const secondsPerBeat = 60.0 / tempo;
        nextNoteTime += secondsPerBeat;
        
        currentBeat = (currentBeat + 1) % beatsPerMeasure;
        playClick();
    }

    function scheduler() {
        while (nextNoteTime < audioContext.currentTime + 0.1) {
            nextBeat();
        }
    }

    function startMetronome() {
        if (!audioContext) createAudioContext();
        nextNoteTime = audioContext.currentTime;
        intervalId = setInterval(scheduler, 25);
        document.getElementById('toggleButton').textContent = 'Stop';
    }

    function stopMetronome() {
        clearInterval(intervalId);
        currentBeat = 0;
        document.getElementById('toggleButton').textContent = 'Start';
    }

    function toggleMetronome() {
        isPlaying = !isPlaying;
        if (isPlaying) {
            startMetronome();
        } else {
            stopMetronome();
        }
    }

    function adjustTempo(change) {
        tempo = Math.min(208, Math.max(40, tempo + change));
        updateTempoDisplay();
    }

    function updateTempoDisplay() {
        document.getElementById('tempoDisplay').textContent = tempo;
        document.getElementById('tempoSlider').value = tempo;
    }

    function updateTimeSignature() {
        beatsPerMeasure = parseInt(document.getElementById('beatsPerMeasure').value);
        currentBeat = 0;
    }

    // Initialize tempo slider
    const slider = document.getElementById('tempoSlider');
    slider.addEventListener('input', function() {
        tempo = parseInt(this.value);
        updateTempoDisplay();
    });

    // Update display on load
    updateTempoDisplay();
    
    // Load initial customer list
    loadCustomers();
</script>
{% endblock %}